function [kerd, keid] = kerdkeid(x)
%===================================================
% The function kerdkeid computes the derivative of
% the Kelvin functions ker(x) and kei(x) for all 
% values of x > 0
% -------------- Reference -------------------------
%  Y. L. Luke : "Mathematical Functions and 
%                their Approximations ",
%                Academic Press 1975 , pp. 337 -341
% --------------------------------------------------
% Author : Jan B. Aarseth, NTNU
%===================================================
%
persistent a b c d g h Isn Iqn Rsn Rqn eulc;
if x<= 0
    error('Non-positive argument in function kerdkeid !');
    return
end
if isempty(a)
    eulc = 0.57721566490153286; % Euler's constant

    % Coefficients for abs(x) <= 8.0
    a(1)  =  4.51042309655904780; b(1)  = -29.3494910970212692;
    a(2)  = 10.84058017381306820; b(2)  =  -8.9886887413382025;
    a(3)  =  8.71271741018667555; b(3)  =   3.4669009758415113;
    a(4)  = -0.85344636969505222; b(4)  =  -0.1473580153212092;
    a(5)  =  0.01904826393473439; b(5)  =   0.0019221031542680;
    a(6)  = -0.00015599761595617; b(6)  =  -0.0000104178992770;
    a(7)  =  0.00000058296292395; b(7)  =   0.0000000277431802;
    a(8)  = -0.00000000113693089; b(8)  =  -0.0000000000405491;
    a(9)  =  0.00000000000127022; b(9)  =   0.0000000000000352;
    a(10) = -0.00000000000000087;

    c(1)  = 25.781092442589601; d(1)  = -19.9976869287633581;
    c(2)  = 14.940512268776533; d(2)  =  -5.3229413802527235;
    c(3)  = -2.484922551596819; d(3)  =   8.1600917317545803;
    c(4)  =  0.075416557488338; d(4)  =  -0.5071607078491981;
    c(5)  = -0.000776498250599; d(5)  =   0.0085923457750343;
    c(6)  =  0.000003489829181; d(6)  =  -0.0000571184191718;
    c(7)  = -0.000000007948362; d(7)  =   0.0000001800268518;
    c(8)  =  0.000000000010153; d(8)  =  -0.0000000003038195;
    c(9)  = -0.000000000000008; d(9)  =   0.0000000000002992;
                                d(10) =  -0.0000000000000001;
                                
    g(1)  =-60.4819042286543817; h(1)  = -20.7661305453050368;
    g(2)  =-65.5193955565946248; h(2)  =   4.6340089303763577;
    g(3)  = 12.3054266464046201; h(3)  =  17.6939191618108129;
    g(4)  = -0.4115511950454370; h(4)  =  -1.2987838466036110;
    g(5)  =  0.0045569840800550; h(5)  =   0.0241984772004112;
    g(6)  = -0.0000216804151922; h(6)  =  -0.0001721444833068;
    g(7)  =  0.0000000517185272; h(7)  =   0.0000005719221427;
    g(8)  = -0.0000000000686797; h(8)  =  -0.0000000010075620;
    g(9)  =  0.0000000000000548; h(9)  =   0.0000000000010290;
                                 h(10) =  -0.0000000000000007;                          
                                
    % Coefficients for abs(x) > 8.0
    
    Isn(1)  =   0.056859527760088042; Isn(14) = - 0.000000000000145994; 
    Isn(2)  =   0.029088750837542663; Isn(15) =   0.000000000000155088; 
    Isn(3)  =   0.000669221059207475; Isn(16) = - 0.000000000000014159;
    Isn(4)  =   0.000008105090636934; Isn(17) = - 0.000000000000008782;
    Isn(5)  = - 0.000002380746811434; Isn(18) =   0.000000000000002814;
    Isn(6)  = - 0.000000234576227487; Isn(19) =   0.000000000000000117;
    Isn(7)  =   0.000000023339348000; Isn(20) = - 0.000000000000000271;
    Isn(8)  =   0.000000005811070546; Isn(21) =   0.000000000000000057;
    Isn(9)  = - 0.000000000579873349; Isn(22) =   0.000000000000000010;
    Isn(10) = - 0.000000000189227720; Isn(23) = - 0.000000000000000008;
    Isn(11) =   0.000000000030503179; Isn(24) =   0.000000000000000001;
    Isn(12) =   0.000000000006758817; Isn(25) =   0.000000000000000000;
    Isn(13) = - 0.000000000002168210; Isn(26) = - 0.000000000000000000;
    
    Iqn(1)  =   0.049862312769161193; Iqn(10) = - 0.000000000006062517; 
    Iqn(2)  =   0.024430212532635263; Iqn(11) =   0.000000000000411474;
    Iqn(3)  = - 0.000485001554807112; Iqn(12) =   0.000000000000008520;
    Iqn(4)  =   0.000015518622052844; Iqn(13) = - 0.000000000000010794; 
    Iqn(5)  = - 0.000000435408068172; Iqn(14) =   0.000000000000002835;
    Iqn(6)  = - 0.000000007527108702; Iqn(15) = - 0.000000000000000561;
    Iqn(7)  =   0.000000003602315702; Iqn(16) =   0.000000000000000094; 
    Iqn(8)  = - 0.000000000534668138; Iqn(17) = - 0.000000000000000013;
    Iqn(9)  =   0.000000000062439081; Iqn(18) =   0.000000000000000001; 
    
    Rsn(1)  =   1.9474730357999224; Rsn(11) = - 0.0000000000360260; 
    Rsn(2)  = - 0.0261298016587433; Rsn(12) =   0.0000000000080124; 
    Rsn(3)  =   0.0001659892491903; Rsn(13) =   0.0000000000011595;
    Rsn(4)  =   0.0000340793652846; Rsn(14) = - 0.0000000000005870;
    Rsn(5)  =   0.0000015975294041; Rsn(15) =   0.0000000000000058;
    Rsn(6)  = - 0.0000002107644309; Rsn(16) =   0.0000000000000388;
    Rsn(7)  = - 0.0000000355671897; Rsn(17) = - 0.0000000000000072;
    Rsn(8)  =   0.0000000032721615; Rsn(18) = - 0.0000000000000015;
    Rsn(9)  =   0.0000000010205523; Rsn(19) =   0.0000000000000009;
    Rsn(10) = - 0.0000000001246830; 
    
    Rqn(1)  =   2.0527691542557544; Rqn(8)  = - 0.0000000002038526; 
    Rqn(2)  =   0.0263227379401625; Rqn(9)  = - 0.0000000000098320; 
    Rqn(3)  = - 0.0000711145128508; Rqn(10) =   0.0000000000047156; 
    Rqn(4)  = - 0.0000083456681187; Rqn(11) = - 0.0000000000009244;
    Rqn(5)  =   0.0000008572290016; Rqn(12) =   0.0000000000001427;
    Rqn(6)  = - 0.0000000676797835; Rqn(13) = - 0.0000000000000185;
    Rqn(7)  =   0.0000000045600148; Rqn(14) =   0.0000000000000018;
end
% ======= ker'(x) and kei'(x) for x <= 8.0 =====
if  x <= 8.0
    x1 = x/8;
    x0 = x1^2;
    xf = 2*(x0)^2 - 1;
    select = 1;
    ber = cheby(a,xf,select);
    beid  = x1*cheby(d,xf,select);
    tkerd = x1*x0*cheby(g,xf,select);
    tkeid = x1*cheby(h,xf,select);
    select = 0;
    bei = x0*cheby(b,xf,select);
    berd  = x1*x0*cheby(c,xf,select);
    tc = eulc + log(x/2);
    kerd = - tc*berd - ber/x + (pi/4)*beid - tkerd;
    keid = - tc*beid - bei/x - (pi/4)*berd + tkeid;
    return
end
% ======= ker'(x) and kei'(x) for abs(x) > 8.0 =====
x0 = 5/x;
xf = 2*x0 - 1;
select = 1;
SIsn = cheby(Isn,xf,select);
SRsn = cheby(Rsn,xf,select);
SIqn = cheby(Iqn,xf,select);
SRqn = cheby(Rqn,xf,select);
u = x/sqrt(2); fac = 0.5*exp(-u)*sqrt(pi/x);
fac1 = cos(3*pi/8 + u); fac2 = sin(3*pi/8 + u);
fac3 = cos(pi/8 + u); fac4 = sin(pi/8 + u);
temp1 = fac4*(SIqn - SRqn) - fac3*(SRqn + SIqn);
kerd  = fac*temp1;
temp2 = fac4*(SRqn + SIqn) - fac3*(SRqn - SIqn);
keid  = fac*temp2;
% ============== CHEBY ===============
function value = cheby(coeff,xf,select)
n = length(coeff);
x = 2*xf;
b1 = 0; b0 = coeff(n);
for k = n-1:-1:1
    b2 = b1;
    b1 = b0;
    b0 = coeff(k) - b2 + x*b1;
end
if select < 0.5
    value = b0 - b1;
else
    value = (b0 - b2)*0.5;
end

